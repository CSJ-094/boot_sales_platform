<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.DashboardDAO">

     <!-- 요약 조회 -->
    <select id="selectSummary"
            resultType="com.boot.dto.SellerDashboardDTO">
        <![CDATA[
        SELECT
            /* 오늘 주문 건수 */
            (
                SELECT COUNT(*)
                  FROM ORDER_DB o
                 WHERE o.ORD_DATE >= TRUNC(SYSDATE)
                   AND o.ORD_DATE <  TRUNC(SYSDATE) + 1
            ) AS todayOrderCount,

            /* 오늘 매출액 */
            (
                SELECT NVL(SUM(o.ORD_AMOUNT), 0)
                  FROM ORDER_DB o
                 WHERE o.ORD_DATE >= TRUNC(SYSDATE)
                   AND o.ORD_DATE <  TRUNC(SYSDATE) + 1
            ) AS todaySalesAmount,

            /* 오늘 신규 가입자 */
            (
                SELECT COUNT(*)
                  FROM USER_DB u
                 WHERE u.MEMBER_REGDATE >= TRUNC(SYSDATE)
                   AND u.MEMBER_REGDATE <  TRUNC(SYSDATE) + 1
            ) AS todayNewMembers,

            /* 오늘 방문자 수 */
            (
                SELECT COUNT(DISTINCT NVL(v.MEMBER_ID, v.IP))
                  FROM VISIT_LOG_DB v
                 WHERE v.VISIT_DATE >= TRUNC(SYSDATE)
                   AND v.VISIT_DATE <  TRUNC(SYSDATE) + 1
            ) AS todayVisitors,

            /* 미처리 문의 수 */
            (
                SELECT COUNT(*)
                  FROM QNA_DB q
                 WHERE q.QNA_PARENT_ID IS NULL
                   AND q.QNA_STATUS = '답변대기'
            ) AS pendingQnaCount,

            /* 어제 주문 건수 */
            (
                SELECT COUNT(*)
                  FROM ORDER_DB o
                 WHERE o.ORD_DATE >= TRUNC(SYSDATE) - 1
                   AND o.ORD_DATE <  TRUNC(SYSDATE)
            ) AS yesterdayOrderCount,

            /* 어제 매출액 */
            (
                SELECT NVL(SUM(o.ORD_AMOUNT), 0)
                  FROM ORDER_DB o
                 WHERE o.ORD_DATE >= TRUNC(SYSDATE) - 1
                   AND o.ORD_DATE <  TRUNC(SYSDATE)
            ) AS yesterdaySalesAmount

        FROM DUAL
        ]]>
    </select>

	<!--	일별 매출-->
	 <select id="selectDailySales"
            resultType="com.boot.dto.SalesStatDTO">
        <![CDATA[
        SELECT
            TO_CHAR(ORD_DATE, 'YYYY-MM-DD') AS label,
            NVL(SUM(ORD_AMOUNT), 0)         AS salesAmount,
            COUNT(*)                        AS orderCount
        FROM ORDER_DB
        WHERE ORD_DATE >= TRUNC(SYSDATE) - 6
          AND ORD_DATE <  TRUNC(SYSDATE) + 1
        GROUP BY TO_CHAR(ORD_DATE, 'YYYY-MM-DD')
        ORDER BY label
        ]]>
    </select>
    
<!--    주별 매출-->
	<select id="selectWeeklySales"
            resultType="com.boot.dto.SalesStatDTO">
        <![CDATA[
        SELECT
            TO_CHAR(ORD_DATE, 'IYYY') || '년 ' || TO_CHAR(ORD_DATE, 'IW') || '주' AS label,
            NVL(SUM(ORD_AMOUNT), 0) AS salesAmount,
            COUNT(*)                AS orderCount
        FROM ORDER_DB
        WHERE ORD_DATE >= TRUNC(SYSDATE, 'IW') - (7 * 7)  -- 최근 8주
          AND ORD_DATE <  TRUNC(SYSDATE, 'IW') + 7
        GROUP BY TO_CHAR(ORD_DATE, 'IYYY'), TO_CHAR(ORD_DATE, 'IW')
        ORDER BY MIN(ORD_DATE)
        ]]>
    </select>
    
<!--    월별 매출-->
 	<select id="selectMonthlySales"
            resultType="com.boot.dto.SalesStatDTO">
        <![CDATA[
        SELECT
            TO_CHAR(ORD_DATE, 'YYYY-MM') AS label,
            NVL(SUM(ORD_AMOUNT), 0)      AS salesAmount,
            COUNT(*)                     AS orderCount
        FROM ORDER_DB
        WHERE ORD_DATE >= ADD_MONTHS(TRUNC(SYSDATE, 'MM'), -5)
          AND ORD_DATE <  ADD_MONTHS(TRUNC(SYSDATE, 'MM'), 1)
        GROUP BY TO_CHAR(ORD_DATE, 'YYYY-MM')
        ORDER BY label
        ]]>
   	 </select>
</mapper>
